# Claude Code Panel REFACTOR Plan

## Context: Tool Panel System Already Implemented

The Tool Panel system (Phases 1 & 2) has been successfully implemented as described in TOOL_PANEL_DESIGN.md. This provides the infrastructure needed for Claude panels:

- **Panel Architecture**: Database schema (`tool_panels` table), panel manager, event bus, and IPC handlers are in place
- **Terminal Panels**: Already working with multiple instances per session, lazy initialization, and state persistence  
- **UI Components**: PanelTabBar, PanelContainer, and panel lifecycle management are implemented
- **Key Features**: Panel bar is always visible below main tabs, panels can run in background, XTerm mounts/unmounts based on active state

Claude Code will be the second panel type added to this system, following the patterns established by Terminal panels.

**THIS IS A REFACTOR, NOT A REWRITE.** Every existing file will be moved to its new location and adapted minimally. No components will be rewritten from scratch.

**Core Principle**: MOVE files first, EDIT them second, NEVER rewrite.

**Implementation Method**: This refactor will be executed by a main agent coordinating with 7 specialized sub-agents, each handling a specific task.

## Critical ID Terminology

**IMPORTANT: Two completely separate ID systems:**

1. **Panel ID** (`panel.id`): Crystal's internal UUID for each panel
   - Used for ALL database operations in Crystal
   - Used for ALL IPC communication
   - Used for ALL UI state management
   - Example: `a7f3d2e1-9b4c-4e6d-8f2a-1c3e5d7b9f11`

2. **Claude Resume ID** (`panel.metadata.claudeResumeId`): Claude Code's internal session identifier
   - ONLY used when calling `claude-code --resume <id>`
   - Stored as metadata in the panel, NEVER as a database key
   - Generated by Claude Code itself, not Crystal
   - Example: `claude_session_abc123xyz789`

**ABSOLUTE RULE: EVERYTHING related to Claude Code MUST have a Panel ID, not a session ID:**
- Every prompt → keyed by Panel ID
- Every message → keyed by Panel ID  
- Every output → keyed by Panel ID
- Every conversation → keyed by Panel ID
- Model settings → stored with Panel ID
- Commit mode settings → stored with Panel ID
- System prompts → stored with Panel ID
- Token usage → tracked by Panel ID
- Error logs → associated with Panel ID

**The Panel ID completely replaces session ID for ALL Claude-related data.**

**Key User Experience Change**: The prompt input bar will move from the session level (always visible) to be integrated within each Claude panel. Each Claude panel will have its own independent prompt bar, conversation history, and Claude process. Multiple Claude panels can run simultaneously within a single session, each with completely independent state.

## Refactoring Goals

1. **100% Code Preservation**: Move ALL existing Claude Code files to new locations intact
2. **Minimal Edits**: Only modify what's necessary for panel integration  
3. **Zero Data Loss**: Preserve all existing session data, outputs, and conversation history
4. **Multiple Independent Claude Instances**: Enable multiple Claude panels per session with independent state
5. **Panel-Integrated Prompt Input**: Relocate prompt bar from session level into each Claude panel (no longer at session level)
6. **Clean File Organization**: Organize existing Claude files into panel module structure
7. **Incremental Refactoring**: Move and test one component at a time

## Current State Analysis

### Existing Claude Code Files (TO BE MOVED, NOT REWRITTEN)

#### Backend Files to Move
- `main/src/services/claudeCodeManager.ts` → Move to `main/src/services/panels/claude/claudeCodeManager.ts`
- `main/src/services/sessionManager.ts` → Keep, but extract Claude-specific code to panel manager
- `main/src/ipc/session.ts` → Keep, add panel routing for Claude operations
- `main/src/events.ts` → Keep, add panel event routing

#### Frontend Files to Move
- `frontend/src/components/session/RichOutputWithSidebar.tsx` → Move to `frontend/src/components/panels/claude/RichOutputWithSidebar.tsx`
- `frontend/src/components/session/RichOutputView.tsx` → Move to `frontend/src/components/panels/claude/RichOutputView.tsx`
- `frontend/src/components/session/MessagesView.tsx` → Move to `frontend/src/components/panels/claude/MessagesView.tsx`
- `frontend/src/components/session/SessionInputWithImages.tsx` → Move to `frontend/src/components/panels/claude/ClaudeInputWithImages.tsx`
- `frontend/src/hooks/useSessionView.ts` → Extract Claude logic to `frontend/src/hooks/useClaudePanel.ts`
- `frontend/src/components/PromptNavigation.tsx` → Move to `frontend/src/components/panels/claude/PromptNavigation.tsx`
- `frontend/src/components/CommitsPanel.tsx` → Move to `frontend/src/components/panels/claude/CommitsPanel.tsx`

#### Data Structure (MUST BE REFACTORED)
- **OLD**: Session outputs stored with session_id
- **NEW**: ALL outputs stored with panel_id
- **OLD**: Conversation messages keyed by session_id  
- **NEW**: Conversation messages keyed by panel_id
- **OLD**: Prompt markers use session_id
- **NEW**: Prompt markers use panel_id
- **OLD**: Settings stored at session level
- **NEW**: Settings stored at panel level (model, commit mode, etc.)

### ViewMode System
- richOutput: Main Claude output view (formatted)
- messages: Raw JSON message inspection view

## Database Changes Required

**Migration Strategy**: "Add Columns and Migrate" - Add panel_id columns to existing tables, populate them, then drop session_id columns after verification.

### Final Database Schema (After Migration)

```sql
-- ============================================
-- CHANGED: session_outputs table
-- Old: Used session_id as foreign key
-- New: Uses panel_id as foreign key
-- ============================================
CREATE TABLE session_outputs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    panel_id TEXT NOT NULL,          -- CHANGED: was session_id
    output_type TEXT NOT NULL,
    content TEXT NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    metadata TEXT,
    FOREIGN KEY (panel_id) REFERENCES tool_panels(id) ON DELETE CASCADE  -- CHANGED: references panels not sessions
);
CREATE INDEX idx_session_outputs_panel_id ON session_outputs(panel_id);  -- CHANGED: index on panel_id

-- ============================================
-- CHANGED: conversation_messages table  
-- Old: Used session_id as foreign key
-- New: Uses panel_id as foreign key
-- ============================================
CREATE TABLE conversation_messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    panel_id TEXT NOT NULL,          -- CHANGED: was session_id
    role TEXT NOT NULL,
    content TEXT NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    metadata TEXT,
    FOREIGN KEY (panel_id) REFERENCES tool_panels(id) ON DELETE CASCADE  -- CHANGED: references panels
);
CREATE INDEX idx_conversation_messages_panel_id ON conversation_messages(panel_id);  -- CHANGED: index on panel_id

-- ============================================
-- CHANGED: prompt_markers table
-- Old: Used session_id as foreign key
-- New: Uses panel_id as foreign key
-- ============================================
CREATE TABLE prompt_markers (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    panel_id TEXT NOT NULL,          -- CHANGED: was session_id
    prompt_text TEXT NOT NULL,
    output_index INTEGER NOT NULL,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    completion_timestamp DATETIME,
    FOREIGN KEY (panel_id) REFERENCES tool_panels(id) ON DELETE CASCADE  -- CHANGED: references panels
);
CREATE INDEX idx_prompt_markers_panel_id ON prompt_markers(panel_id);  -- CHANGED: index on panel_id

-- ============================================
-- CHANGED: execution_diffs table
-- Old: Used session_id as foreign key
-- New: Uses panel_id as foreign key
-- ============================================
CREATE TABLE execution_diffs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    panel_id TEXT NOT NULL,          -- CHANGED: was session_id
    execution_number INTEGER NOT NULL,
    diff_content TEXT NOT NULL,
    files_changed INTEGER DEFAULT 0,
    insertions INTEGER DEFAULT 0,
    deletions INTEGER DEFAULT 0,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (panel_id) REFERENCES tool_panels(id) ON DELETE CASCADE  -- CHANGED: references panels
);
CREATE INDEX idx_execution_diffs_panel_id ON execution_diffs(panel_id);  -- CHANGED: index on panel_id

-- ============================================
-- NEW: claude_panel_settings table
-- Stores all Claude-specific settings per panel
-- Replaces session-level Claude settings
-- ============================================
CREATE TABLE claude_panel_settings (
    panel_id TEXT PRIMARY KEY,       -- NEW: Each Claude panel has its own settings
    model TEXT DEFAULT 'claude-3-opus-20240229',
    commit_mode BOOLEAN DEFAULT 0,
    system_prompt TEXT,
    max_tokens INTEGER DEFAULT 4096,
    temperature REAL DEFAULT 0.7,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (panel_id) REFERENCES tool_panels(id) ON DELETE CASCADE
);

-- ============================================
-- EXISTING: tool_panels table (with Claude panels)
-- Already exists, stores Claude Resume ID in metadata
-- ============================================
CREATE TABLE tool_panels (
    id TEXT PRIMARY KEY,              -- Panel ID (UUID)
    session_id TEXT NOT NULL,         -- Parent session (worktree)
    type TEXT NOT NULL,               -- 'terminal' or 'claude'
    title TEXT NOT NULL,
    state TEXT,                       -- JSON with panel state
    metadata TEXT,                    -- JSON with claudeResumeId for Claude panels
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);

-- ============================================
-- REMOVED from sessions table after migration:
-- - claude_session_id (moved to panel metadata)
-- - claude_model (moved to claude_panel_settings)
-- - claude_commit_mode (moved to claude_panel_settings)
-- - claude_system_prompt (moved to claude_panel_settings)
-- ============================================
```

## Implementation Plan Using Sub-Agents

### How to Execute This Refactor

**IMPORTANT**: This refactor should be executed by a main agent that:
1. Creates and coordinates 7 specialized sub-agents
2. Assigns each sub-agent one specific task from below
3. Ensures tasks are completed in order (some can be parallel)
4. Verifies success criteria before proceeding to next task
5. Reports completion status of each task

**Execution Order**:
- Task 1 MUST be completed first (file movement)
- Tasks 2, 3, and 4 can be done in parallel after Task 1
- Task 5 requires Tasks 3 and 4 to be complete
- Task 6 can start after Task 2 is complete
- Task 7 is the final verification after all other tasks

## Implementation Tasks for Sub-Agents

### Task 1: File Movement and Directory Setup
**Sub-Agent Type**: File Refactoring Agent  
**Goal**: Move all Claude-related files to their new panel locations without breaking imports.

**Instructions for Sub-Agent**:
1. Create directories: `main/src/services/panels/claude/` and `frontend/src/components/panels/claude/`
2. Use `git mv` to move each file (preserves history):
   - `main/src/services/claudeCodeManager.ts` → `main/src/services/panels/claude/`
   - All 7 frontend components → `frontend/src/components/panels/claude/`
3. Search entire codebase for imports of moved files
4. Update every import path to new location
5. Run build to verify no broken imports

**Success Criteria**: All files moved, imports updated, app compiles and runs exactly as before.

---

### Task 2: Database Migration
**Sub-Agent Type**: Database Migration Agent
**Goal**: Add panel_id columns to all Claude tables and create migration script.

**Instructions for Sub-Agent**:
1. Create migration file: `main/src/database/migrations/004_claude_panels.sql`
2. Add `panel_id TEXT` column to each table (nullable initially):
   - session_outputs, conversation_messages, prompt_markers, execution_diffs
3. Create `claude_panel_settings` table as shown in schema
4. Write data migration logic:
   - For each existing session with Claude data
   - Create a Claude panel entry in tool_panels
   - Copy session_id values to panel_id columns
   - Store existing claude_session_id as claudeResumeId in panel metadata
5. Test migration on sample database

**Success Criteria**: Migration script runs without errors, all Claude data now has panel_id.

---

### Task 3: Backend Panel Infrastructure
**Sub-Agent Type**: Backend Integration Agent
**Goal**: Create Claude panel manager wrapper and update type definitions.

**Instructions for Sub-Agent**:
1. Edit `shared/types/panels.ts`:
   - Add 'claude' to ToolPanelType enum
   - Create ClaudePanelState interface with claudeResumeId field
   - Add claude entry to PANEL_CAPABILITIES
2. Create `main/src/services/panels/claude/claudePanelManager.ts`:
   - Import existing claudeCodeManager
   - Create thin wrapper class that maps panel_id → claudeResumeId
   - All methods delegate to claudeCodeManager with mapped IDs
3. Create `main/src/ipc/claudePanel.ts`:
   - Copy relevant handlers from `ipc/session.ts`
   - Change all to accept panel_id instead of session_id
   - Route to claudePanelManager

**Success Criteria**: Claude panels can be created and managed via panel_id.

---

### Task 4: Frontend Panel Components
**Sub-Agent Type**: Frontend Integration Agent
**Goal**: Create ClaudePanel wrapper component using moved files.

**Instructions for Sub-Agent**:
1. Create `frontend/src/components/panels/claude/ClaudePanel.tsx`:
   - Import all moved Claude components
   - Arrange them in same layout as before
   - Move SessionInputWithImages INTO the panel
   - Pass panel prop instead of session prop
2. Create `frontend/src/hooks/useClaudePanel.ts`:
   - Copy Claude-specific code from useSessionView.ts
   - Change all session_id references to panel_id
   - Keep original hook unchanged
3. Update moved components:
   - Change props to accept panel instead of session
   - Update all state keys from session_id to panel_id

**Success Criteria**: Claude panel renders with all existing functionality.

---

### Task 5: Integration and Wiring
**Sub-Agent Type**: UI Integration Agent
**Goal**: Connect Claude panels to the existing panel system.

**Instructions for Sub-Agent**:
1. Edit `frontend/src/components/panels/PanelContainer.tsx`:
   - Add case for 'claude' panel type
   - Import and render ClaudePanel component
2. Edit `frontend/src/components/SessionView.tsx`:
   - Comment out (don't delete) session-level prompt bar
   - Add condition: if Claude panel exists, hide richOutput/messages tabs
   - Keep terminal integration as-is
3. Edit `main/src/ipc/session.ts`:
   - In session creation handler, if prompt provided:
   - Create Claude panel after session
   - Store panel_id in session for backward compatibility
4. Add routing in existing IPC handlers:
   - If session_id provided, find first Claude panel
   - Route to panel-based handler

**Success Criteria**: Claude panels appear in panel bar, old sessions auto-migrate.

---

### Task 6: Update All Queries and References
**Sub-Agent Type**: Code Search and Replace Agent
**Goal**: Systematically replace every session_id with panel_id for Claude data.

**Instructions for Sub-Agent**:
1. Search for all database queries involving Claude tables:
   - Find queries to: session_outputs, conversation_messages, prompt_markers, execution_diffs
   - Replace `WHERE session_id = ?` with `WHERE panel_id = ?`
   - Update INSERT statements to use panel_id
2. Search frontend for Claude-related state:
   - Find all uses of session_id in Claude components
   - Replace with panel_id
   - Update store keys and selectors
3. Search for IPC calls related to Claude:
   - Update all to send panel_id instead of session_id
4. Verify settings are per-panel:
   - Model, commit mode, system prompts now keyed by panel_id

**Success Criteria**: Zero references to session_id in Claude code paths.

---

### Task 7: Final Cleanup and Verification
**Sub-Agent Type**: Testing and Verification Agent
**Goal**: Comment out deprecated code and verify everything works.

**Instructions for Sub-Agent**:
1. Comment out (DO NOT DELETE) in SessionView.tsx:
   - richOutput and messages tabs
   - Session-level prompt bar
   - Old Claude view components
2. Test new session creation:
   - Create session with prompt → Claude panel auto-created
   - Create session without prompt → No Claude panel
   - Add Claude panel manually → Works correctly
3. Test existing session migration:
   - Open existing session → Claude panel auto-created
   - All data accessible via panel
   - Claude Resume ID works for --resume
4. Test multiple panels:
   - Create 2+ Claude panels in one session
   - Each has independent conversation
   - Each has own settings

**Success Criteria**: All test scenarios pass, no regressions detected.


## Code Organization (AFTER REFACTOR)

### Final File Structure (ALL MOVED FILES)
Backend organization:
- `services/panels/claude/claudeCodeManager.ts` (MOVED from services/)
- `services/panels/claude/claudePanelManager.ts` (NEW wrapper - maps Panel ID ↔ Claude Resume ID)
- `ipc/claudePanel.ts` (NEW routing layer - all handlers use Panel ID)

Frontend organization:
- `components/panels/claude/RichOutputWithSidebar.tsx` (MOVED)
- `components/panels/claude/RichOutputView.tsx` (MOVED)
- `components/panels/claude/MessagesView.tsx` (MOVED)
- `components/panels/claude/ClaudeInputWithImages.tsx` (MOVED & renamed)
- `components/panels/claude/PromptNavigation.tsx` (MOVED)
- `components/panels/claude/CommitsPanel.tsx` (MOVED)
- `components/panels/claude/ClaudePanel.tsx` (NEW wrapper)
- `hooks/useClaudePanel.ts` (EXTRACTED from useSessionView)

## Risk Mitigation

### Risk 1: Process Management Complexity
Reuse existing ClaudeCodeManager, wrap with panel interface

### Risk 2: State Synchronization Issues
Single source of truth in database, careful event handling

### Risk 3: User Confusion During Migration
Clear communication, gradual transition, helpful prompts

### Risk 4: Performance Degradation
Lazy loading, efficient state management, profiling

### Risk 5: Breaking Existing Workflows
Comprehensive backward compatibility layer

## Key Architectural Changes Summary

### Before Migration (Current State)
- Single Claude instance per session
- Session-level prompt bar always visible
- Shared conversation history
- Tab-based Claude views

### After Migration (New Panel System)
- Multiple Claude instances per session
- Panel-integrated prompt bars
- Independent conversation histories
- Panel-based Claude views

### User Experience Impact
- Users explicitly create Claude panels when needed
- Multiple contexts with different prompts simultaneously
- Prompt bar only visible when Claude panel active
- Switching panels switches conversations
- Each panel consumes independent resources

### Technical Benefits
- True isolation between Claude instances
- Parallel workflows on different tasks
- Better organization by problem aspect
- Cleaner architecture with logical grouping
- Scalability limited only by system resources

## ID Usage Examples

### Correct Usage (Panel ID for EVERYTHING):
```
// Starting Claude process
const panelId = "a7f3d2e1-9b4c-4e6d-8f2a-1c3e5d7b9f11";
const panel = await db.getPanel(panelId);
const claudeResumeId = panel.metadata.claudeResumeId || generateNewClaudeId();
spawn(`claude-code --resume ${claudeResumeId}`); // ONLY place Resume ID is used

// ALL data operations use Panel ID:
await db.savePrompt(panelId, promptText);           // Prompts keyed by Panel ID
await db.saveMessage(panelId, messageData);         // Messages keyed by Panel ID
await db.saveOutput(panelId, outputData);           // Outputs keyed by Panel ID
await db.saveConversation(panelId, conversation);   // Conversations keyed by Panel ID
await db.updateModelSettings(panelId, 'claude-3-opus'); // Settings keyed by Panel ID
await db.setCommitMode(panelId, true);              // Commit mode keyed by Panel ID
await db.trackTokenUsage(panelId, tokens);         // Token usage keyed by Panel ID
```

### Incorrect Usage (NEVER use session_id for Claude data):
```
// WRONG - Don't use session ID for Claude data
await db.saveOutput(sessionId, outputData); // ❌ WRONG - use Panel ID

// WRONG - Don't use Claude Resume ID as database key
await db.saveOutput(claudeResumeId, outputData); // ❌ WRONG - use Panel ID

// WRONG - Don't store settings at session level
await db.updateSessionModel(sessionId, model); // ❌ WRONG - use Panel ID
```

## Key Refactoring Principles

1. **NEVER REWRITE** - Every file is moved, not rewritten
2. **GIT MV FIRST** - Use git mv to preserve history
3. **MINIMAL EDITS** - Only change what's absolutely necessary
4. **WRAPPERS NOT REWRITES** - New code wraps existing code
5. **TEST AFTER EACH MOVE** - Verify functionality after every file move
6. **KEEP OLD CODE** - Comment out, don't delete, for rollback
7. **INCREMENTAL CHANGES** - One file at a time
8. **BACKWARD COMPATIBLE** - Old code paths continue working
9. **PANEL ID IS KEY** - Panel ID used for everything except --resume flag

## Conclusion

This REFACTOR plan (not a rewrite) provides a structured approach to moving Claude Code into the new panel system. The most critical change is that **EVERY piece of Claude-related data must now be keyed by Panel ID instead of session ID**. This includes all prompts, messages, outputs, conversations, settings, and configurations.

By moving files instead of rewriting them, creating thin wrappers instead of new implementations, and systematically replacing session_id with panel_id throughout the codebase, we achieve true panel independence while preserving all existing functionality. 

The refactor ensures that each Claude panel is completely self-contained with its own:
- Conversation history (keyed by Panel ID)
- Model settings (keyed by Panel ID)
- System prompts (keyed by Panel ID)
- Output history (keyed by Panel ID)
- All other data (keyed by Panel ID)

The only exception is the Claude Resume ID, which is stored as metadata and used exclusively for the `--resume` flag when spawning Claude Code processes.